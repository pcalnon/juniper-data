---
####################################################################################################################################################################################################
# Project:       Juniper
# Prototype:     Juniper Canopy: Monitoring/Diagnostic Frontend for CasCor
# File Name:     ci.yml
# Author:        Paul Calnon
# Version:       0.10.0
#
# Date:          2025-11-03
# Last Modified: 2025-12-09
#
# License:       MIT License
# Copyright:     Copyright (c) 2024-2025 Paul Calnon
#
# Description:
#    GitHub Actions CI/CD Pipeline for Juniper Canopy CasCor NN Frontend
#    - Runs tests on every push and PR
#    - Generates coverage reports
#    - Enforces quality gates
#    - Supports multiple Python versions
#####################################################################################################################################################################################################

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - feature/**
      - fix/**
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # python-version: 3.13
          python-version: 3.14

      - name: Install Linting Tools
        run: |
          echo "Installing linting tools..."
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
          python3 -m pip install types-requests

      - name: Run Black (Format Check)
        run: |
          echo "Running Black..."
          black --check --diff src/ || true
        continue-on-error: true

      - name: Run isort (Import Sort Check)
        run: |
          echo "Running isort..."
          isort --check-only --diff src/ || true
        continue-on-error: true

      - name: Run Flake8 (Linter)
        run: |
          echo "Running Flake8..."
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero, errors are warnings (warnings won't fail the build)
          flake8 src/ --count --max-line-length=120 --statistics --exit-zero
        continue-on-error: true

      - name: Run MyPy (Type Checker)
        run: |
          echo "Running MyPy..."
          mypy src/ --ignore-missing-imports --no-strict-optional || true
        continue-on-error: true

  test:
    name: Test Suite (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        # python-version: ["3.11", "3.12", "3.13", "3.14"]
        python-version: ["3.14"]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ matrix.python-version }}
          # channels: conda-forge,pytorch,plotly,defaults
          channels: conda-forge,pytorch,nvidia,plotly,RMG,numba,jasonb857,ehmoussi,konstantin-orangeqs

          miniforge-version: latest
          use-mamba: true

          channel-priority: flexible
          activate-environment: JuniperCanopy
          environment-file: conf/conda_environment.yaml
          auto-activate-base: false

      - name: Verify Conda Environment
        shell: bash -el {0}
        run: |
          echo "Verifying Conda Environment..."
          conda env list
          conda info
          conda list
          conda list -n JuniperCanopy
          which python
          python --version
          pip --version
          df -h

      - name: Display Directory Contents
        run: |
          echo "Displaying directory contents..."
          ls -Flah /home
          ls -Flah /home/runner/work/juniper_canopy/juniper_canopy
          ls -Flah /opt
          ls -Flah /usr
          ls -Flah /usr/share
          ls -Flah /usr/local
          ls -Flah /usr/local/lib

      - name: Free up disk space
        run: |
          echo "Freeing up disk space..."
          df -h
          conda clean --all
          sudo rm -rf /usr/share/dotnet/
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          df -h

      - name: Install Dependencies
        shell: bash -el {0}
        run: |
          echo "Installing dependencies..."
          python -m pip install --upgrade pip
          pip install -r conf/requirements.txt

      - name: Verify Test Files
        shell: bash -el {0}
        run: |
          echo "Verifying test files..."
          echo "=== Test Directory Structure ==="
          ls -la src/tests/
          echo ""
          echo "=== Test Files ==="
          find src/tests -name "test_*.py" -type f
          echo ""
          echo "=== Conftest Files ==="
          find src/tests -name "conftest.py" -type f

      - name: Run Tests with Coverage
        shell: bash -el {0}
        env:
          # CI test environment configuration
          # Disabled standard in CI
          CASCOR_BACKEND_AVAILABLE: 0  # (Enable when needed in nightly build)
          RUN_SERVER_TESTS: 0  # Disabled (requires live server)
          ENABLE_SLOW_TESTS: 0  # Skip slow tests for fast feedback

        run: |
          cd src
          # Run tests excluding external dependencies
          pytest tests/ \
            --verbose \
            -m "not requires_cascor and not requires_server and not slow" \
            --cov=. \
            --cov-report=xml:../coverage.xml \
            --cov-report=term-missing \
            --cov-report=html:../reports/coverage \
            --junit-xml=../reports/junit/results.xml \
            --html=../reports/test_report.html \
            --self-contained-html \
            --continue-on-collection-errors \
            || true
        continue-on-error: true

      # Regression Test Suite
      # Runs critical regression tests to prevent known issues from reoccurring
      # - Metrics panel data format validation
      # -     (prevents data display regressions)
      # - API contract verification (ensures backend/frontend compatibility)
      # - End-to-end dashboard tests (validates full user workflow)
      - name: Run Regression Tests
        shell: bash -el {0}
        # pytest tests/unit/test_metrics_panel.py::
        #     TestMetricsPanelDataFormatRegression -v
        run: |
          cd sr
          pytest tests/unit/test_metrics_panel.py -v
          pytest tests/integration/test_api_contracts.py -v
          pytest tests/integration/test_dashboard_e2e.py -v
        continue-on-error: false  # Fail build if regression tests fail

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            reports/coverage/
            coverage.xml
          retention-days: 30

      - name: Upload Coverage HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: reports/coverage/
          retention-days: 30

      - name: Check Coverage Threshold
        shell: bash -el {0}
        run: |
          cd src
          COVERAGE="$(pytest tests/ --cov=. --cov-report=term-missing)"
          COVERAGE="$(echo "${COVERAGE}" | grep "TOTAL")"
          COVERAGE="$(echo "${COVERAGE}" | awk '{print $NF}' | sed 's/%//')"
          echo "Current coverage: ${COVERAGE}%"

          # Warning threshold (don't fail, just warn)
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "::warning::Coverage is below 80% (current: ${COVERAGE}%)"
          fi

          # Failure threshold (fail the build)
          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "::error::Coverage critically low: ${COVERAGE}% (min: 60%)"
            exit 1
          fi
        continue-on-error: true

      - name: Test Summary
        shell: bash -el {0}
        run: |
          echo "=== Test Summary ==="
          if [ -f reports/junit/results.xml ]; then
            echo "Test results generated successfully"
            cat reports/junit/results.xml | grep -o 'tests="[0-9]*"'&& {
                echo "Tests completed";
            }
          else
            echo "No test results file found"
          fi

  build:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # python-version: "3.13"
          python-version: "3.14"

      - name: Check disk space
        run: df -h

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Verify Project Structure
        run: |
          echo "=== Project Structure ==="
          ls -la
          echo ""
          echo "=== Source Directory ==="
          ls -la src/

      - name: Check for Syntax Errors
        run: |
          python -m py_compile src/**/*.py || true
        continue-on-error: true

      - name: Build Summary
        run: |
          echo "=== Build Information ==="
          echo "Python Version: $(python --version)"
          echo "Project: Juniper Canopy"
          echo -ne "Version: "
          echo "$(grep 'Version:' src/main.py | head -1 | awk '{print $3}')"
          echo "Build Date: $(date -u)"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          # python-version: "3.13"
          python-version: "3.14"
          # channels: conda-forge,pytorch,plotly,defaults
          channels: conda-forge,pytorch,nvidia,RMG,numba,jasonb857,ehmoussi,konstantin-orangeqs
          channel-priority: flexible
          activate-environment: JuniperCanopy
          environment-file: conf/conda_environment.yaml
          auto-activate-base: false

      - name: Install Dependencies
        shell: bash -el {0}
        run: |
          python -m pip install --upgrade pip
          pip install -r conf/requirements.txt

      - name: Run Integration Tests Only
        shell: bash -el {0}
        env:
          CASCOR_BACKEND_AVAILABLE: 0
          RUN_SERVER_TESTS: 0
          ENABLE_SLOW_TESTS: 0
        run: |
          cd src
          pytest tests/integration/ \
            --verbose \
            --maxfail=5 \
            -m "integration and not requires_cascor and not requires_server" \
            || true
        continue-on-error: true

      - name: Integration Test Summary
        shell: bash -el {0}
        run: |
          echo "=== Integration Tests Completed ==="
          echo "Note: Some tests may require external dependencies"

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: always()

    steps:
      - name: Check Quality Gate
        run: |
          echo "=== Quality Gate Status ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Build: ${{ needs.build.result }}"

          # Determine overall status
          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "::error::Tests failed - Quality gate FAILED"
            exit 1
          elif [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "::warning::Linting failed - Consider fixing before merge"
          elif [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "::error::Build failed - Quality gate FAILED"
            exit 1
          else
            echo "::notice::Quality gate PASSED âœ“"
          fi

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: always()

    steps:
      - name: Build Status
        run: |
          echo "=== CI/CD Pipeline Complete ==="
          echo "Status: ${{ needs.quality-gate.result }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
