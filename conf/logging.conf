#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperCanopy
# Application:   juniper_canopy
# Purpose:       Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
#
# Author:        Paul Calnon
# Version:       1.0.0
# File Name:     logging.conf
# File Path:     <Project>/<Sub-Project>/<Application>/conf/
#
# Date:          2025-11-21
# Last Modified: 2025-12-25
#
# License:       MIT License
# Copyright:     Copyright (c) 2024,2025,2026 Paul Calnon
#
# Description:
#     This script is used to perform leveled logging for the JuniperCanopy util scripts.
#
#####################################################################################################################################################################################################
# Notes:
#     WARNING:  This config file is sourced by the config files for the api_request.bash and launch_close.bash scripts.
#
#     IMPORTANT NOTE:  Don't add check for re-sourcing this file; it breaks all the things.  Control is an illusion, man; just let it happen.  The dude abides.
#     IMPORTANT NOTE:  Colors are defined in the sourced config file: log_colors.conf
#
#     This script functions as a config file and is used to perform leveled logging for the Close scripts.
#     The supported logging levels are TRACE, VERBOSE, DEBUG, INFO, WARNING, ERROR, CRITICAL, and FATAL.
#
#     Logging Levels:
#         - The TRACE level is only logged if the log level variable is set to a value <= TRACE_LEVEL, returns 0
#         - The VERBOSE level is only logged if the log level variable is set to a value <= VERBOSE_LEVEL, returns 0
#         - The DEBUG level is only logged if the log level variable is set to a value <= DEBUG_NUM or if the DEBUG environment variable is set to TRUE, returns 0
#         - The INFO level is always logged if the log level variable is set to a value <= INFO_NUM or if the DEBUG environment variable is set to TRUE, returns 0
#         - The WARNING level is always logged if the log level variable is set to a value <= WARNING_NUM or if the DEBUG environment variable is set to TRUE, returns 0
#         - The ERROR level is always logged and the script if the log level variable is set to a value <= ERROR_NUM or if the DEBUG environment variable is set to TRUE, returns 1
#         - The CRITICAL level is always logged if the log level variable is set to a value <= CRITICAL_NUM or if the DEBUG environment variable is set to TRUE, exits with 1
#         - The FATAL level is always logged if the log level variable is set to a value <= FATAL_NUM or if the DEBUG environment variable is set to TRUE, exits with 1
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#     TODO: need to finish refactor of logging.conf and logging_functions.conf
#
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define General Logging Constants
#####################################################################################################################################################################################################
# export TRUE="0"
# export FALSE="1"

# export DEBUG="${TRUE}"
# # export DEBUG="${FALSE}"


#####################################################################################################################################################################################################
# Check if this config file has already been sourced.  Only Source this conf file Once
#####################################################################################################################################################################################################
# echo "logging.conf: Check if this config file has already been sourced.  Only Source this conf file Once"
if [[ "${JUNIPER_LOGGING_CONF_SOURCED}" != "${TRUE}" ]]; then
    JUNIPER_LOGGING_CONF_SOURCED="${TRUE}"
    export TRUNCATED_LOGS="${FALSE}"
else
    log_warning "${LOGGING_NAME}.${CONF_EXT} already sourced.  Skipping re-source."
    # [[ "${DEBUG}" == "${TRUE}" ]] && exit $(( TRUE )) || return $(( TRUE ))
    return $(( TRUE ))
fi


#####################################################################################################################################################################################################
# Define Available Logging Levels
#     NOTE: These need to be exported so that util functions can set their own log levels
#####################################################################################################################################################################################################
# echo "logging.conf: Define Available Logging Levels"
export TRACE_LEVEL=0
export VERBOSE_LEVEL=1
export DEBUG_LEVEL=2
export INFO_LEVEL=3
export WARNING_LEVEL=4
export ERROR_LEVEL=5
export CRITICAL_LEVEL=6
export FATAL_LEVEL=7


# export DEFAULT_LEVEL="${TRACE_LEVEL}"     # Set default log level to TRACE
# export DEFAULT_LEVEL="${VERBOSE_LEVEL}"   # Set default log level to VERBOSE
# export DEFAULT_LEVEL="${DEBUG_LEVEL}"     # Set default log level to DEBUG
# export DEFAULT_LEVEL="${INFO_LEVEL}"      # Set default log level to INFO
# export DEFAULT_LEVEL="${WARNING_LEVEL}"   # Set default log level to WARNING
export DEFAULT_LEVEL="${ERROR_LEVEL}"     # Set default log level to ERROR
# export DEFAULT_LEVEL="${CRITICAL_LEVEL}"  # Set default log level to CRITICAL
# export DEFAULT_LEVEL="${FATAL_LEVEL}"     # Set default log level to FATAL
# echo "logging.conf: DEFAULT_LEVEL: ${DEFAULT_LEVEL}"


#####################################################################################################################################################################################################
# Define Script Specific Logging Constants
#####################################################################################################################################################################################################
# echo "logging.conf: Define Script Specific Logging Constants"
export SCRIPT_NAME_ID="1"
export LINE_NO_ID="0"
export FUNC_NAME_ID="1"

export TAB_SIZE="4"

# export EXIT_ON_NO_LOG_COLORS="${FALSE}"
export EXIT_ON_NO_LOG_COLORS="${TRUE}"

export LOG_COLORS_FILE_PREFIX="logging_colors"
export LOG_FUNCTIONS_FILE_PREFIX="logging_functions"


#####################################################################################################################################################################################################
# Define constants for error logging termination settings
#####################################################################################################################################################################################################
# echo "logging.conf: Define constants for error logging termination settings"

# Set Default Return Value by Logging Level Function
# echo "logging.conf: Set Default Return Value by Logging Level Function"
export EXIT_TRACE="${TRUE}"
export EXIT_VERBOSE="${TRUE}"
export EXIT_DEBUG="${TRUE}"
export EXIT_INFO="${TRUE}"
export EXIT_WARNING="${TRUE}"
export EXIT_ERROR="${FALSE}"
export EXIT_CRITICAL="${FALSE}"
export EXIT_FATAL="${FALSE}"

# Flag to determine default error handling for error-related logging: set to True if an error should terminate this application process by default.
# echo "logging.conf: Set Default Error Handling by Logging Level Function"
export TERM_TRACE="${FALSE}"
export TERM_VERBOSE="${FALSE}"
export TERM_DEBUG="${FALSE}"
export TERM_INFO="${FALSE}"
export TERM_WARNING="${FALSE}"
export TERM_ERROR="${FALSE}"
export TERM_CRITICAL="${TRUE}"
export TERM_FATAL="${TRUE}"


#####################################################################################################################################################################################################
# Define Label and Number Constants for Logging Levels
#####################################################################################################################################################################################################
# echo "logging.conf: Define Label and Number Constants for Logging Levels"
export TRACE_NUM=1
export VERBOSE_NUM=5
export DEBUG_NUM=10
export INFO_NUM=20
export WARNING_NUM=30
export ERROR_NUM=40
export CRITICAL_NUM=50
export FATAL_NUM=60

declare -a LOG_LABELS=("[TRACE]" "[VERBOSE]" "[DEBUG]" "[INFO]" "[WARNING]" "[ERROR]" "[CRITICAL]" "[FATAL]")
export LOG_LABELS

declare -a LOG_NUMBERS=("${TRACE_NUM}" "${VERBOSE_NUM}" "${DEBUG_NUM}" "${INFO_NUM}" "${WARNING_NUM}" "${ERROR_NUM}" "${CRITICAL_NUM}" "${FATAL_NUM}")
export LOG_NUMBERS

export LOG_LEVEL="${DEFAULT_LEVEL}"         # Set log level to the default level
export LOG_LEVEL_NUM="${LOG_NUMBERS[${LOG_LEVEL}]}"


#####################################################################################################################################################################################################
# Validate and source the logging functions config file
#####################################################################################################################################################################################################
# echo "logging.conf: Validate and source the logging functions config file"
LOG_FUNCTIONS_FILE_NAME="${LOG_FUNCTIONS_FILE_PREFIX}.${CONF_EXT}"
# echo "logging.conf: LOG_FUNCTIONS_FILE_NAME: ${LOG_FUNCTIONS_FILE_NAME}"
export LOG_FUNCTIONS_FILE="${CONF_DIR}/${LOG_FUNCTIONS_FILE_NAME}"
# echo "logging.conf: LOG_FUNCTIONS_FILE: ${LOG_FUNCTIONS_FILE}"

[[ ( "${LOG_FUNCTIONS_FILE}" == "" ) || ( ! -f "${LOG_FUNCTIONS_FILE}" ) ]] && log_fatal "Logging Functions Conf file not found: ${LOG_FUNCTIONS_FILE}"
# echo "logging.conf: Sourcing Logging Functions file: ${LOG_FUNCTIONS_FILE}"
source "${LOG_FUNCTIONS_FILE}"; SUCCESS="$?"

# [[ "${DEBUG}" == "${TRUE}" ]] && { bash "${LOG_FUNCTIONS_FILE}"; SUCCESS="$?"; } || { source "${LOG_FUNCTIONS_FILE}"; SUCCESS="$?"; }
# if [[ "${DEBUG}" == "${TRUE}" ]]; then
#     echo "logging.conf: Executing Logging Functions file in debug mode: ${LOG_FUNCTIONS_FILE}"
#     # shellcheck disable=SC1090,SC2015
#     bash "${LOG_FUNCTIONS_FILE}"
#     # source "${LOG_FUNCTIONS_FILE}"
#     SUCCESS="$?"
#     echo "logging.conf: Completed Executing Logging Functions file in debug mode: ${LOG_FUNCTIONS_FILE}"
# else
#     echo "logging.conf: Sourcing Logging Functions file in non-debug mode: ${LOG_FUNCTIONS_FILE}"
#     # shellcheck disable=SC1090,SC2015
#     source "${LOG_FUNCTIONS_FILE}"
#     SUCCESS="$?"
#     echo "logging.conf: Completed Sourcing Logging Functions file in non-debug mode: ${LOG_FUNCTIONS_FILE}"
# fi
# echo "logging.conf: Completed Sourcing Logging Functions file: ${LOG_FUNCTIONS_FILE}"
[[ "${SUCCESS}" != "${TRUE}" ]] && log_fatal "Failed to source Logging Functions file: \"${LOG_FUNCTIONS_FILE}\", (returned: ${SUCCESS})"
# echo "logging.conf: Successfully sourced Logging Functions file: ${LOG_FUNCTIONS_FILE}"


#####################################################################################################################################################################################################
# Call logging function to validate logging file and create if needed
#####################################################################################################################################################################################################
# echo "logging.conf: Call logging function: check_log_file to validate logging file and create if needed"
# echo "logging.conf: Log File: \"${LOG_FILE}\""
# echo "logging.conf: Log file name: \"$(basename "${LOG_FILE}")\""
# echo "logging.conf: Log file directory: \"$(dirname "${LOG_FILE}")\""

# [[ if_defined "check_log_file" != "${TRUE}" ]] && log_fatal "Logging function: check_log_file not defined.  Cannot validate log file: ${LOG_FILE}."
# FIX: Logic was inverted - is_defined returns 0 (TRUE) when function IS defined, so we need to negate
! is_defined "check_log_file" && log_fatal "Logging function: check_log_file not defined.  Cannot validate log file: ${LOG_FILE}."
# echo "logging.conf: Calling logging function: check_log_file"

check_log_file "$(basename "${LOG_FILE}")" "$(dirname "${LOG_FILE}")"; SUCCESS="$?"
# echo "logging.conf: Completed calling logging function: check_log_file."
# echo "logging.conf: Checking if Calling logging function is needed: init_logging_env"
# [[ "${SUCCESS}" != "${TRUE}" ]] && { init_logging_env; SUCCESS="$?"; }
if [[ "${SUCCESS}" != "${TRUE}" ]]; then
    # echo "logging.conf: Calling logging function: init_logging_env"
    init_logging_env
    SUCCESS="$?"
    # echo "logging.conf: Completed calling logging function: init_logging_env"
fi
# echo "logging.conf: Completed calling logging function: check_log_file and init_logging_env"
[[ "${SUCCESS}" != "${TRUE}" ]] && log_fatal "Failed to validate the Juniper Canopy log file: ${LOG_FILE}, (returned: ${SUCCESS})"
# echo "logging.conf: Successfully validated the Juniper Canopy log file: ${LOG_FILE}"


#####################################################################################################################################################################################################
# Clear logs only if in Debug mode
#####################################################################################################################################################################################################
log_debug "Clear logs only at the beginning of a new script run and only if in Debug mode"
if [[ "${TRUNCATED_LOGS}" != "${TRUE}" ]]; then
    log_trace "Juniper Canopy log file: ${LOG_FILE} has not yet been truncated"
    [[ "${DEBUG}" == "${TRUE}" ]] && cat /dev/null > "${LOG_FILE}"
    log_trace "Truncated the Juniper Canopy log file: ${LOG_FILE}"
    export TRUNCATED_LOGS="${TRUE}"
fi

log_debug "Successfully Completed sourcing Logging Functions file: \"${LOG_FUNCTIONS_FILE}\", (returned \"${SUCCESS}\")"  # Standard Logging is available from this point
log_debug "Successfully Completed validating the Juniper Canopy log file: ${LOG_FILE}"
log_debug "Successfully Completed truncating the Juniper Canopy log file: ${LOG_FILE}"


#####################################################################################################################################################################################################
# Define and Source Logging Colors Config file for sourcing
#####################################################################################################################################################################################################
LOG_COLORS_FILE_NAME="${LOG_COLORS_FILE_PREFIX}.${CONF_EXT}"
export LOG_COLORS_FILE="${CONF_DIR}/${LOG_COLORS_FILE_NAME}"

[[ ( "${LOG_COLORS_FILE}" == "" ) || ( ! -f "${LOG_COLORS_FILE}" ) ]] && { [[ "${EXIT_ON_NO_LOG_COLORS}" == "${TRUE}" ]] && log_fatal "Log Colors Conf file not found: ${LOG_COLORS_FILE}, (Exit on No Log Colors: ${TRUE})"; }
# [[ "${DEBUG}" == "${TRUE}" ]] && { bash "${LOG_COLORS_FILE}"; SUCCESS="$?"; } || { source "${LOG_COLORS_FILE}"; SUCCESS="$?"; }
# shellcheck disable=SC1090
source "${LOG_COLORS_FILE}"; SUCCESS="$?"
[[ ( "${SUCCESS}" != "${TRUE}" ) && ( "${EXIT_ON_NO_LOG_COLORS}" == "${TRUE}" ) ]] && log_fatal "Failed to source the Log Colors Conf file: ${LOG_COLORS_FILE}, (Exit on No Log Colors: ${TRUE})"
log_debug "Completed sourcing Log Colors Conf file: \"${LOG_COLORS_FILE}\", (returned \"${SUCCESS}\")"

#####################################################################################################################################################################################################
# Define Constants for Logging Level Colors (must be after logging_colors.conf is sourced)
#####################################################################################################################################################################################################
export COLOR_TRACE="${BLACK_BOLD_DARK}"
export COLOR_VERBOSE="${BLACK_BOLD}"
export COLOR_DEBUG="${BLUE_BRIGHT}"
export COLOR_INFO="${GREEN}"
export COLOR_WARNING="${YELLOW_BOLD}"
export COLOR_ERROR="${RED_BRIGHT}"
export COLOR_CRITICAL="${WHITE_ON_RED:-${WHITE_BOLD_ON_RED}}"
export COLOR_FATAL="${WHITE_BOLD_BRIGHT_ON_RED}"

# Create log level colors array
declare -a LOG_COLORS=("${COLOR_TRACE}" "${COLOR_VERBOSE}" "${COLOR_DEBUG}" "${COLOR_INFO}" "${COLOR_WARNING}" "${COLOR_ERROR}" "${COLOR_CRITICAL}" "${COLOR_FATAL}")
export LOG_COLORS


#####################################################################################################################################################################################################
# Verify Logging Environment Setup if DEBUG is set to TRUE
#####################################################################################################################################################################################################
if [[ "${DEBUG}" == "${TRUE}" ]]; then
    log_debug "Testing Logging Function Colors"

    log_trace     "Logging functions exported: I am Trace!"
    log_verbose   "Logging functions exported: I am Verbose!"
    log_debug     "Logging functions exported: I am Debug!"
    log_info      "Logging functions exported: I am Info!"
    log_warning   "Logging functions exported: I am Warning!"
    log_error     "Logging functions exported: I am Error!"    "${TRUE}" "${FALSE}"  # These extra params cause the log function to return "${TRUE}" and not terminate
    log_critical  "Logging functions exported: I am Critical!" "${TRUE}" "${FALSE}"  # These extra params cause the log function to return "${TRUE}" and not terminate
    log_fatal     "Logging functions exported: I am Fatal!"    "${TRUE}" "${FALSE}"  # These extra params cause the log function to return "${TRUE}" and not terminate

    log_trace "Completed Testing Logging Function Colors"
fi

# [[ "${DEBUG}" == "${TRUE}" ]] && exit $(( TRUE )) || return $(( TRUE ))
return $(( TRUE ))
