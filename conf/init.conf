#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Prototype:     Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
# File Name:     init.conf
# Author:        Paul Calnon
# Version:       0.1.4 (0.7.3)
#
# Date:          2025-11-10
# Last Modified: 2025-12-17
#
# License:       MIT License
# Copyright:     Copyright (c) 2024-2025 Paul Calnon
#
# Description:
#    This Script serves as the initialization config file for the Juniper Project's juniper_canopy prototype
#    Warning:  This Script / Config file is sourced by the try.bash script
#
#####################################################################################################################################################################################################
# Notes:
#     Warning:  This Config file is sourced by the all Juniper Canopy util scripts including the try.bash and get_code_stats.bash scripts
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define Top Level Constants for Script
#####################################################################################################################################################################################################
export TRUE="0"
export FALSE="1"

# export DEBUG="${FALSE}"
export DEBUG="${TRUE}"


#####################################################################################################################################################################################################
# Define Constants for Common and Logging config files
#####################################################################################################################################################################################################
BASH_EXT="bash"
CONF_EXT="conf"
UTIL_DIR_NAME="util"

COMMON_CONF_PREFIX="common"
LOGGING_CONF_PREFIX="logging"


#####################################################################################################################################################################################################
# Build Config File dir
#####################################################################################################################################################################################################
CURRENT_PATH="$(realpath "${BASH_SOURCE[0]}")"
# echo "Script Path: ${CURRENT_PATH}"
# SCRIPT_NAME="$(basename "${CURRENT_PATH}")"
# echo "Script Name: ${SCRIPT_NAME}"
CURRENT_DIR="$(dirname "${CURRENT_PATH}")"
# echo "Script Dir: ${CURRENT_DIR}"
PROJ_ROOT_DIR="$(dirname "${CURRENT_DIR}")"
# echo "Project Root Dir: ${PROJ_ROOT_DIR}"
# SCRIPT_NAME_ROOT="${SCRIPT_NAME%.*}"
# echo "Script Name Root: ${SCRIPT_NAME_ROOT}"
CONF_DIR="${PROJ_ROOT_DIR}/${CONF_EXT}"
# echo "Config Dir: ${CONF_DIR}"


#####################################################################################################################################################################################################
# Build Logging and Common Config File Names and paths
#####################################################################################################################################################################################################
export LOGGING_CONF_FILE_NAME="${LOGGING_CONF_PREFIX}.${CONF_EXT}"
# echo "Logging conf file name: ${LOGGING_CONF_FILE_NAME}"
export LOGGING_CONF_FILE="${CONF_DIR}/${LOGGING_CONF_FILE_NAME}"
# echo "LOGGING_CONF_FILE: ${LOGGING_CONF_FILE}"
export COMMON_CONF_FILE_NAME="${COMMON_CONF_PREFIX}.${CONF_EXT}"
# echo "Common conf file name: ${COMMON_CONF_FILE_NAME}"
export COMMON_CONF_FILE="${CONF_DIR}/${COMMON_CONF_FILE_NAME}"
# echo "COMMON_CONF_FILE: ${COMMON_CONF_FILE}"


#####################################################################################################################################################################################################
# Validate and source the logging config file
#####################################################################################################################################################################################################
[[ ! -f "${LOGGING_CONF_FILE}" ]] && { echo "Error: Logging Config File: \"${LOGGING_CONF_FILE}\" does not exist"; exit 1; }
# Source the logging config file
# echo "Logging Conf File: \"${LOGGING_CONF_FILE}\""
# echo "source \"${LOGGING_CONF_FILE}\""
source "${LOGGING_CONF_FILE}"; SUCCESS="$?"
[[ "${SUCCESS}" != "0" ]] && { echo "Error: Failed to source Logging config file: \"${LOGGING_CONF_FILE}\", (returned: ${SUCCESS})"; exit 1; }
log_debug "Completed Successfully sourcing Logging config file: \"${LOGGING_CONF_FILE}\", (returned \"${SUCCESS}\")"


# PARENT_CONF_DIR="${PARENT_ROOT_DIR}/${CONF_EXT}"
# echo "Parent Conf Dir: ${PARENT_CONF_DIR}"
# PARENT_CONF_FILE="${PARENT_CONF_DIR}/${PARENT_CONF_FILENAME}"
# echo "Parent Conf File: ${PARENT_CONF_FILE}"

#####################################################################################################################################################################################################
# Validate and source the common config file
#####################################################################################################################################################################################################
if [[ ! -f "${COMMON_CONF_FILE}" ]]; then
    echo "Error: Common Config File: \"${COMMON_CONF_FILE}\" does not exist"
    exit 1
fi

#####################################################################################################################################################################################################
# Current Config file info
#####################################################################################################################################################################################################
SCRIPT_PATH="$(realpath "${BASH_SOURCE[0]}")"
echo "Script Path: ${SCRIPT_PATH}"
SCRIPT_NAME="$(basename "${SCRIPT_PATH}")"
echo "Script Name: ${SCRIPT_NAME}"
SCRIPT_DIR="$(dirname "${SCRIPT_PATH}")"
echo "Script Dir: ${SCRIPT_DIR}"
PROJ_ROOT_DIR="$(dirname "${SCRIPT_DIR}")"
echo "Project Root Dir: ${PROJ_ROOT_DIR}"
SCRIPT_NAME_ROOT="${SCRIPT_NAME%.*}"
echo "Script Name Root: ${SCRIPT_NAME_ROOT}"
CONF_DIR="${PROJ_ROOT_DIR}/${CONF_EXT}"
echo "Config Dir: ${CONF_DIR}"


#####################################################################################################################################################################################################
# Get parent script info and constants
#####################################################################################################################################################################################################
PARENT_PID="${PPID}"
echo "Child: Parent Pid: \"${PARENT_PID}\""

# IFS== read -d '' _ PARENT_CMD < /proc/${PARENT_PID}/cmdline
PARENT_CMD="$( tr -d '\0' < /proc/${PARENT_PID}/cmdline )"
echo "Parent Raw Call: From cmd: \"${PARENT_CMD}\""


#####################################################################################################################################################################################################
# Get the Name of the Parent Script
#####################################################################################################################################################################################################
PARENT_CALL="$(ps -o args= ${PARENT_PID})"
echo "Parent Raw Call: From ps: \"${PARENT_CALL}\""
echo "Parent Script Path Param: ${PARENT_SCRIPT_PATH_PARAM}"

if [[ ( "${PARENT_CALL}" != "" ) && ( "${PARENT_CALL}" != "${BASH_EXT}" ) ]]; then
    PARENT_SCRIPT_REL="$(echo "${PARENT_CALL}" | awk '{print $2}')"
    echo "Parent Rel Path: ${PARENT_SCRIPT_REL}"
    PARENT_SCRIPT_PATH="$(realpath "${PARENT_SCRIPT_REL}")"
    echo "Parent Abs Path: ${PARENT_SCRIPT_PATH}"
elif [[ ( "${PARENT_SCRIPT_PATH_PARAM}" != "" ) && ( -f "${PARENT_SCRIPT_PATH_PARAM}" ) ]]; then
    PARENT_SCRIPT_PATH="${PARENT_SCRIPT_PATH_PARAM}"
    echo "Parent Script Path: ${PARENT_SCRIPT_PATH}"
else
    echo "Error: Unable to determine Parent Script Path: \"${PARENT_SCRIPT_PATH}\""
    exit 0
fi


#####################################################################################################################################################################################################
# Build Parent Script Config File Path
#####################################################################################################################################################################################################
PARENT_CONF="${PARENT_SCRIPT_PATH%.*}.${CONF_EXT}"
echo "Parent Config: ${PARENT_CONF}"
PARENT_CONF_FILENAME="$(basename "${PARENT_CONF}")"
echo "Parent Config Filename: ${PARENT_CONF_FILENAME}"
PARENT_DIR="$(dirname "${PARENT_CONF}")"
echo "Parent Dir: ${PARENT_DIR}"
PARENT_ROOT_DIR="$(dirname "${PARENT_DIR}")"
echo "Parent Root Dir: ${PARENT_ROOT_DIR}"
# PARENT_CONF_DIR="${PARENT_ROOT_DIR}/${CONF_EXT}"
# echo "Parent Conf Dir: ${PARENT_CONF_DIR}"
# PARENT_CONF_FILE="${PARENT_CONF_DIR}/${PARENT_CONF_FILENAME}"
# echo "Parent Conf File: ${PARENT_CONF_FILE}"


#####################################################################################################################################################################################################
# Get project directory constants
#####################################################################################################################################################################################################
export HOME_DIR="${HOME}"
export PROJ_NAME="Juniper"
export SUB_PROJ_NAME="JuniperCanopy"
export APP_NAME="juniper_canopy"
export PROJ_LANG_DIR_NAME="python"
export DEV_DIR_NAME="Development"
export DEV_DIR="${HOME_DIR}/${DEV_DIR_NAME}"
export PROJ_ROOT_DIR="${DEV_DIR}/${PROJ_LANG_DIR_NAME}"
export PROJ_DIR="${PROJ_ROOT_DIR}/${SUB_PROJ_NAME}/${APP_NAME}"
export PROJ_UTIL_DIR="${PROJ_DIR}/${UTIL_DIR_NAME}"
export PROJ_CONF_DIR="${PROJ_DIR}/${CONF_EXT}"


#####################################################################################################################################################################################################
# Validate config dir
#####################################################################################################################################################################################################
if [[ ( ( "${PARENT_CONF_DIR}" == "" ) || ( ! -d "${PARENT_CONF_DIR}" ) ) && ( ( "${PROJ_CONF_DIR}" == "" ) && ( ! -d "${PROJ_CONF_DIR}" ) ) ]]; then
    echo "Error: Both Parent Conf Dir: \"${PARENT_CONF_DIR}\" and Project Conf Dir: \"${PROJ_CONF_DIR}\" are empty or do not exist"
    exit 1
elif [[ ( "${PARENT_CONF_DIR}" == "" ) || ( ! -d "${PARENT_CONF_DIR}" ) ]]; then
    CONF_DIR="${PROJ_CONF_DIR}"
    echo "Parent Conf Dir: \"${PARENT_CONF_DIR}\", is empty or does not exist, using Project Conf Dir: \"${PROJ_CONF_DIR}\""
else
    CONF_DIR="${PARENT_CONF_DIR}"
    echo "Parent Conf Dir: \"${PARENT_CONF_DIR}\" is valid, using Parent Conf Dir"
fi


#####################################################################################################################################################################################################
# Build and Validate the Common Config File
#####################################################################################################################################################################################################
export COMMON_CONF_FILE="${CONF_DIR}/${COMMON_CONF_FILE_NAME}"
echo "COMMON_CONF_FILE: ${COMMON_CONF_FILE}"

# Validate the common config file
if [[ ! -f "${COMMON_CONF_FILE}" ]]; then
    echo "Error: Common Config File: \"${COMMON_CONF_FILE}\" does not exist"
    exit 1
fi


#####################################################################################################################################################################################################
# Build and Validate the Logging Config File
#####################################################################################################################################################################################################
export LOGGING_CONF_FILE="${CONF_DIR}/${LOGGING_CONF_FILE_NAME}"
echo "LOGGING_CONF_FILE: ${LOGGING_CONF_FILE}"

# Validate the logging config file
if [[ ! -f "${LOGGING_CONF_FILE}" ]]; then
    echo "Error: Logging Config File: \"${LOGGING_CONF_FILE}\" does not exist"
    exit 1
fi


#####################################################################################################################################################################################################
# Validate Parent Script Primary config file
#####################################################################################################################################################################################################
CONF_FILE="${PARENT_CONF_FILE}"
echo "CONF_FILE: ${CONF_FILE}"

# Validate the Parent Script's primary config file
if [[ "${CONF_FILE}" == "" ]]; then
    echo "Error: Config File: \"${CONF_FILE}\" is empty"
    exit 1
elif [[ ! -f "${CONF_FILE}" ]]; then
    echo "Error: Config File: \"${CONF_FILE}\" does not exist"
    exit 1
else
    echo "Config File: \"${CONF_FILE}\" is valid"
fi


#####################################################################################################################################################################################################
# Source the config files
#####################################################################################################################################################################################################
# Source the logging config file
echo "Logging Conf File: \"${LOGGING_CONF_FILE}\""
echo "source \"${LOGGING_CONF_FILE}\""
source "${LOGGING_CONF_FILE}"; SUCCESS="$?"
log_debug "Completed sourcing Logging config file. Returned \"${SUCCESS}\""

# Source the common config file
echo "Common Conf File: \"${COMMON_CONF_FILE}\""
echo "source \"${COMMON_CONF_FILE}\""
source "${COMMON_CONF_FILE}"; SUCCESS="$?"
log_debug "Completed sourcing Common config file. Returned \"${SUCCESS}\""

# Source the primary config file for the parent script
echo "Conf file: \"${CONF_FILE}\""
echo "source \"${CONF_FILE}\""
source "${CONF_FILE}"; SUCCESS="$?"

# Validate the source of the primary config file
if [[ "${SUCCESS}" != "0" ]]; then
    echo "Error: Failed to source Primary config file: \"${CONF_FILE}\""
    exit 1
fi
log_debug "Completed sourcing Primary config file. Returned \"${SUCCESS}\""

return 0
