#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperCanopy
# Application:   juniper_canopy
# Purpose:       Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
#
# Author:        Paul Calnon
# Version:       0.1.4 (0.7.3)
# File Name:     init.conf
# File Path:     /home/paulcalnon/juniper_canopy/conf/
#
# Date:          2025-11-10
# Last Modified: 2025-12-19
#
# License:       MIT License
# Copyright:     Copyright (c) 2024,2025,2026 Paul Calnon
#
# Description:
#    This Script serves as the initialization config file for the Juniper Project's juniper_canopy prototype
#    Warning:  This Script / Config file is sourced by the try.bash script
#
#####################################################################################################################################################################################################
# Notes:
#     Warning:  This Config file is sourced by the all Juniper Canopy util scripts including the try.bash and get_code_stats.bash scripts
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define Top Level Constants for Script
#####################################################################################################################################################################################################
export TRUE="0"
export FALSE="1"

export DEBUG="${FALSE}"
# export DEBUG="${TRUE}"


#####################################################################################################################################################################################################
# Get calling script info constants for safe logging
#####################################################################################################################################################################################################
export SCRIPT_NAME_ID="1"
export LINE_NO_ID="0"
export FUNC_NAME_ID="1"

export CONF_EXT="conf"
export LOGS_EXT="log"
export LOGS_DIR="${LOGS_EXT}s"

export FUNCTION_CONF_INFIX="_fn"


#####################################################################################################################################################################################################
# Add function to check for existence of logging functions
#####################################################################################################################################################################################################
CALLING_PATH=""
CALLING_DIR=""
CALLING_SCRIPT=""
CALLING_LINE=""
CALLING_FUNC=""

CURRENT_PATH=""
CURRENT_SCRIPT=""
CURRENT_DIR=""
CURRENT_LINE=""
CURRENT_FUNC=""

APP_DIR=""
APP_NAME=""

LOG_FILENAME=""
LOG_DIR=""
LOG_FILE=""


#####################################################################################################################################################################################################
# Validate and source the function config file
#####################################################################################################################################################################################################
CURRENT_NAME="$(basename "$(realpath "${BASH_SOURCE[0]}")")"
echo "Current Name: ${CURRENT_NAME}"
CONF_DIR="$(dirname "$(dirname "$(realpath "${BASH_SOURCE[0]}")")")/${CONF_EXT}"
echo "CONF_DIR: ${CONF_DIR}"
INIT_FN_FILE="${CONF_DIR}/${CURRENT_NAME%.*}${FUNCTION_CONF_INFIX}.${CURRENT_NAME#*.}"
echo "INIT_FN_FILE: ${INIT_FN_FILE}"

if [[ -f "${INIT_FN_FILE}" ]]; then
    echo "Debug: ${DEBUG}"
    [[ "${DEBUG}" == "${TRUE}" ]] && { echo "Running"; bash "${INIT_FN_FILE}"; SUCCESS="$?"; } || { echo "Sourcing"; source "${INIT_FN_FILE}"; SUCCESS="$?"; }
    log_debug "Completed sourcing Init Function file: \"${INIT_FN_FILE}\", (returned \"${SUCCESS}\")"
    [[ "${SUCCESS}" != "${TRUE}" ]] && log_critical "Failed to source Init Function file: \"${INIT_FN_FILE}\", (returned: ${SUCCESS})"
    log_debug "Successfully Completed sourcing Init Function file: \"${INIT_FN_FILE}\", (returned \"${SUCCESS}\")"
else
    MESSAGE="Init Function File: \"${INIT_FN_FILE}\" does not exist"
    echo "${MESSAGE}"
    CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    echo "Calling Script: ${CALLING_SCRIPT}"
    CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    echo "Calling Line: ${CALLING_LINE}"
    CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    echo "Calling Func: ${CALLING_FUNC}"
    COLOR_FATAL="\033[1;97;41m"
    echo "COLOR_FATAL: ${COLOR_FATAL}"
    RESET="\033[0m"                   # Reset
    printf "%b%-21s %-28s %-21s %-11s %s%b\n" "${COLOR_FATAL}" "($(date +%F_%T))" "${CALLING_SCRIPT}:${CALLING_LINE})" "${CALLING_FUNC}:" "[FATAL]" "${MESSAGE}" "${RESET}" 2>&1
    set -e; exit $(( FALSE ))
fi
echo "Init function conf file has been sourced"


#####################################################################################################################################################################################################
# Define Project specific Directory Names
#####################################################################################################################################################################################################
export HOME_DIR="${HOME}"
log_trace "Home Dir: \"${HOME_DIR}\""
export PROJ_NAME="Juniper"
log_trace "Project Name: \"${PROJ_NAME}\""
export SUB_PROJ_NAME="JuniperCanopy"
log_trace "Sub-Project Name: \"${SUB_PROJ_NAME}\""
export APP_NAME="juniper_canopy"
log_trace "Application Name: \"${APP_NAME}\""
export PROJ_LANG_DIR_NAME="python"
log_trace "Project Language Dir Name: \"${PROJ_LANG_DIR_NAME}\""
export DEV_DIR_NAME="Development"
log_trace "Dev Dir Name: \"${DEV_DIR_NAME}\""


#####################################################################################################################################################################################################
# Define Constants for Common and Logging config files
#####################################################################################################################################################################################################
export BASH_EXT="bash"
log_trace "BASH_EXT: ${BASH_EXT}"
export CONF_EXT="conf"
log_trace "CONF_EXT: ${CONF_EXT}"
export LOGS_EXT="log"
log_trace "LOGS_EXT: ${LOGS_EXT}"

export UTIL_DIR_NAME="util"
log_trace "UTIL_DIR_NAME: ${UTIL_DIR_NAME}"
export LOGS_DIR_NAME="${LOGS_EXT}s"
log_trace "LOGS_DIR_NAME: ${LOGS_DIR_NAME}"
export CONF_DIR_NAME="${CONF_EXT}"
log_trace "CONF_DIR_NAME: ${CONF_DIR_NAME}"

COMMON_CONF_PREFIX="common"
log_trace "COMMON_CONF_PREFIX: ${COMMON_CONF_PREFIX}"
LOGGING_CONF_PREFIX="logging"
log_trace "LOGGING_CONF_PREFIX: ${LOGGING_CONF_PREFIX}"
FAIL_CONF_PREFIX="config_fail"
log_trace "FAIL_CONF_PREFIX: ${FAIL_CONF_PREFIX}"
FUNCTION_CONF_INFIX="_fn"
log_trace "FUNCTION_CONF_INFIX: ${FUNCTION_CONF_INFIX}"
PARENT_INFO_COUNT=3
log_trace "PARENT_INFO_COUNT: ${PARENT_INFO_COUNT}"


#####################################################################################################################################################################################################
# Build function, Logging, and Common Config File Names and paths
#####################################################################################################################################################################################################
CURRENT_PATH="$(realpath "${BASH_SOURCE[0]}")"
log_trace "CURRENT_PATH: ${CURRENT_PATH}"
CURRENT_NAME="$(basename "${CURRENT_PATH}")"
log_trace "CURRENT_NAME: ${CURRENT_NAME}"
CURRENT_DIR="$(dirname "${CURRENT_PATH}")"
log_trace "CURRENT_DIR: ${CURRENT_DIR}"
PROJ_ROOT_DIR="$(dirname "${CURRENT_DIR}")"
log_trace "PROJ_ROOT_DIR: ${PROJ_ROOT_DIR}"
CONF_DIR="${PROJ_ROOT_DIR}/${CONF_EXT}"
log_trace "CONF_DIR: ${CONF_DIR}"


#####################################################################################################################################################################################################
# Validate and source the logging config file
#####################################################################################################################################################################################################
CONFIG_LOGGING_FILE_NAME="${LOGGING_CONF_PREFIX}.${CONF_EXT}"
log_trace "CONFIG_LOGGING_FILE_NAME: ${CONFIG_LOGGING_FILE_NAME}"
CONFIG_LOGGING_FILE="${CONF_DIR}/${CONFIG_LOGGING_FILE_NAME}"
log_trace "CONFIG_LOGGING_FILE: ${CONFIG_LOGGING_FILE}"

[[ ! -f "${CONFIG_LOGGING_FILE}" ]] && log_critical "Config Failure File: \"${CONFIG_LOGGING_FILE}\" does not exist"
if [[ "${DEBUG}" == "${TRUE}" ]]; then
    log_trace "Running Logging Config File: \"${CONFIG_LOGGING_FILE}\""
    bash "${CONFIG_LOGGING_FILE}"; SUCCESS="$?"
else
    log_trace "Sourcing Logging Config File: \"${CONFIG_LOGGING_FILE}\""
    source "${CONFIG_LOGGING_FILE}"; SUCCESS="$?"
fi
[[ "${SUCCESS}" != "0" ]] && log_critical "Error: Failed to Call the Logging Config file: \"${CONFIG_LOGGING_FILE}\", (returned: ${SUCCESS})"


# #####################################################################################################################################################################################################
# # Validate and source the function config file
# #     NOTE: log_critical and its alias log_error, defined in config_fail.conf file, are the only log function available.
# #####################################################################################################################################################################################################
# # TODO: This needs to be a common function
# INIT_FN_FILE_NAME="${CURRENT_NAME%.*}${FUNCTION_CONF_INFIX}.${CURRENT_NAME#*.}"
# log_debug "INIT_FN_FILE_NAME: ${INIT_FN_FILE_NAME}"
# INIT_FN_FILE="${CONF_DIR}/${INIT_FN_FILE_NAME}"
# log_debug "INIT_FN_FILE: ${INIT_FN_FILE}"


# # TODO: This is borked.  file name isn't updated after init_fn.conf

# [[ ! -f "${INIT_FN_FILE}" ]] && log_critical "Init Function File: \"${INIT_FN_FILE}\" does not exist"
# if [[ "${DEBUG}" == "${TRUE}" ]]; then
#     log_trace " Running Init Function File: \"${INIT_FN_FILE}\""
#     bash "${INIT_FN_FILE}"; SUCCESS="$?"
# else
#     log_trace "Sourcing Init Function File: \"${INIT_FN_FILE}\""
#     source "${INIT_FN_FILE}"; SUCCESS="$?"
# fi
# log_debug "Completed sourcing Init Function file: \"${INIT_FN_FILE}\", (returned \"${SUCCESS}\")"
# [[ "${SUCCESS}" != "${TRUE}" ]] && log_critical "Failed to source Init Function file: \"${INIT_FN_FILE}\", (returned: ${SUCCESS})"
# log_debug "Successfully Completed sourcing Init Function file: \"${INIT_FN_FILE}\", (returned \"${SUCCESS}\")"


#####################################################################################################################################################################################################
# Validate and source the common config file
#####################################################################################################################################################################################################
COMMON_CONF_FILE_NAME="${COMMON_CONF_PREFIX}.${CONF_EXT}"
log_trace "COMMON_CONF_FILE_NAME: ${COMMON_CONF_FILE_NAME}"
COMMON_CONF_FILE="${CONF_DIR}/${COMMON_CONF_FILE_NAME}"
log_trace "COMMON_CONF_FILE: ${COMMON_CONF_FILE}"

[[ ! -f "${COMMON_CONF_FILE}" ]] && log_critical "Common Config File: \"${COMMON_CONF_FILE}\" does not exist"
if [[ "${DEBUG}" == "${TRUE}" ]]; then
    log_trace "Running Common Config File: \"${COMMON_CONF_FILE}\""
    bash "${COMMON_CONF_FILE}"; SUCCESS="$?"
else
    log_trace "Sourcing Common Config File: \"${COMMON_CONF_FILE}\""
    source "${COMMON_CONF_FILE}"; SUCCESS="$?"
fi
log_trace "Completed Calling the Common Config File: ${COMMON_CONF_FILE}"
[[ "${SUCCESS}" != "0" ]] && log_critical "Error: Failed to source Common config file: \"${COMMON_CONF_FILE}\", (returned: ${SUCCESS})"
log_debug "Successfully Completed sourcing Common config file: \"${COMMON_CONF_FILE}\", (returned \"${SUCCESS}\")"


#####################################################################################################################################################################################################
# Parse and Validate the Parent Path Param
#####################################################################################################################################################################################################
PARENT_PATH_PARAM="$(realpath "${PARENT_PATH_PARAM}")"
log_trace "PARENT_PATH_PARAM: ${PARENT_PATH_PARAM}"

[[ ("${PARENT_PATH_PARAM}" == "") || ( ! -f "${PARENT_PATH_PARAM}" ) ]] && log_critical "Parent Path Param: ${PARENT_PATH_PARAM} is not a valid file. Unable to Continue."
log_debug "Received Valid Parent Path Param: ${PARENT_PATH_PARAM}"


#####################################################################################################################################################################################################
# Retrieve and Validate parent script info and constants
#####################################################################################################################################################################################################
PARENT_PID="${PPID}"
log_trace "PARENT_PID: ${PARENT_PID}"
PARENT_CMD="$( tr -d '\0' < /proc/${PARENT_PID}/cmdline )"
log_trace "PARENT_CMD: ${PARENT_CMD}"
PARENT_CALL="$(ps -o args= ${PARENT_PID})"
log_trace "PARENT_CALL: ${PARENT_CALL}"
PARENT_PARAM="${PARENT_PATH_PARAM}"
log_trace "PARENT_PARAM: ${PARENT_PARAM}"

log_debug "Parent Param: ${PARENT_PARAM}"
validate_parent_path "${PARENT_CMD}" "${PARENT_CALL}" "${PARENT_PARAM}"
log_debug "Parent Script Path: \"${PARENT_SCRIPT_PATH}\""


#####################################################################################################################################################################################################
# Build Parent Script Config File Path
#####################################################################################################################################################################################################
PARENT_CONF="${PARENT_SCRIPT_PATH%.*}.${CONF_EXT}"
log_debug "Parent Script Config File: \"${PARENT_CONF}\""
PARENT_CONF_FILENAME="$(basename "${PARENT_CONF}")"
log_debug "Parent Script Config File Name: \"${PARENT_CONF_FILENAME}\""
PARENT_DIR="$(dirname "${PARENT_CONF}")"
log_debug "Parent Script Config File Dir: \"${PARENT_DIR}\""
PARENT_ROOT_DIR="$(dirname "${PARENT_DIR}")"
log_debug "Parent Script Config File Root Dir: \"${PARENT_ROOT_DIR}\""
PARENT_CONF_DIR="${PARENT_ROOT_DIR}/${CONF_EXT}"
log_debug "Parent Script Config Dir: \"${PARENT_CONF_DIR}\""


#####################################################################################################################################################################################################
# Get project directory constants
#####################################################################################################################################################################################################
DEV_DIR="${HOME_DIR}/${DEV_DIR_NAME}"
log_debug "Dev Dir: \"${DEV_DIR}\""
PROJ_ROOT_DIR="${DEV_DIR}/${PROJ_LANG_DIR_NAME}"
log_debug "Project Root Dir: \"${PROJ_ROOT_DIR}\""
PROJ_DIR="${PROJ_ROOT_DIR}/${SUB_PROJ_NAME}/${APP_NAME}"
log_debug "Project Dir: \"${PROJ_DIR}\""
PROJ_CONF_DIR="${PROJ_DIR}/${CONF_EXT}"
log_debug "Project Config Dir: \"${PROJ_CONF_DIR}\""


#####################################################################################################################################################################################################
# Validate config directory and Primary Config File for calling script
#####################################################################################################################################################################################################
validate_conf_dir "${PARENT_CONF_DIR}" "${PROJ_CONF_DIR}"
log_info "Successfully Validated conf dir for Calling Script primary config file: \"${PARENT_CONF_DIR}\""
CONF_FILE="${PARENT_CONF_DIR}/${PARENT_CONF_FILENAME}"
log_debug "Calling Script Primary Conf File: \"${CONF_FILE}\""
validate_conf_file "${CONF_FILE}"; SUCCESS="$?"
[[ "${SUCCESS}" != "${TRUE}" ]] && log_critical "Error: Failed to validate Primary config file: \"${CONF_FILE}\""
log_info "Successfully Validated the Parent Script's primary config file: ${CONF_FILE}"
export CONF_FILE


#####################################################################################################################################################################################################
# Source the Calling Script's Primary config file and check result
#####################################################################################################################################################################################################
log_debug "Sourcing Calling Script's Primary config file: \"${CONF_FILE}\""
if [[ "${DEBUG}" == "${TRUE}" ]]; then
    log_debug "Running Calling Script's Primary config file: \"${CONF_FILE}\""
    bash "${CONF_FILE}"; SUCCESS="$?"
else
    log_debug "Sourcing Calling Script's Primary config file: \"${CONF_FILE}\""
    source "${CONF_FILE}"; SUCCESS="$?"
fi
log_debug "Completed calling the Conf File: ${CONF_FILE}"
[[ "${SUCCESS}" != "${TRUE}" ]] && log_critical "Error: Failed to source Primary config file: \"${CONF_FILE}\""
log_info "Completed sourcing Primary config file. Returned \"${SUCCESS}\""

[[ "${DEBUG}" == "${TRUE}" ]] && exit $(( TRUE )) || return $(( TRUE ))
