#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Prototype:     Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
# File Name:     init.conf
# Author:        Paul Calnon
# Version:       0.1.4 (0.7.3)
#
# Date:          2025-11-10
# Last Modified: 2025-12-18
#
# License:       MIT License
# Copyright:     Copyright (c) 2024-2025 Paul Calnon
#
# Description:
#    This Script serves as the initialization config file for the Juniper Project's juniper_canopy prototype
#    Warning:  This Script / Config file is sourced by the try.bash script
#
#####################################################################################################################################################################################################
# Notes:
#     Warning:  This Config file is sourced by the all Juniper Canopy util scripts including the try.bash and get_code_stats.bash scripts
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#   TODO: move failure message logging to init.conf
#   TODO: create a function definition conf file to be sourced by init.
#   TODO: have bash scripts validate existence of init.conf file and fail if it does not exist
#   TODO: let failed sourced be handled by init.conf
#
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define Top Level Constants for Script
#####################################################################################################################################################################################################
export TRUE="0"
export FALSE="1"

# export DEBUG="${FALSE}"
export DEBUG="${TRUE}"


#####################################################################################################################################################################################################
# Define Project specific Directory Names
#####################################################################################################################################################################################################
export HOME_DIR="${HOME}"
export PROJ_NAME="Juniper"
export SUB_PROJ_NAME="JuniperCanopy"
export APP_NAME="juniper_canopy"
export PROJ_LANG_DIR_NAME="python"
export DEV_DIR_NAME="Development"


#####################################################################################################################################################################################################
# Define Constants for Common and Logging config files
#####################################################################################################################################################################################################
BASH_EXT="bash"
CONF_EXT="conf"
UTIL_DIR_NAME="util"

COMMON_CONF_PREFIX="common"
LOGGING_CONF_PREFIX="logging"
FAIL_CONF_PREFIX="config_fail"
FUNCTION_CONF_INFIX="_fn"

PARENT_INFO_COUNT=3


#####################################################################################################################################################################################################
# Build function, Logging, and Common Config File Names and paths
#####################################################################################################################################################################################################
CURRENT_PATH="$(realpath "${BASH_SOURCE[0]}")"
CURRENT_NAME="$(basename "${CURRENT_PATH}")"
CURRENT_DIR="$(dirname "${CURRENT_PATH}")"
PROJ_ROOT_DIR="$(dirname "${CURRENT_DIR}")"
CONF_DIR="${PROJ_ROOT_DIR}/${CONF_EXT}"


#####################################################################################################################################################################################################
# Validate and source the config failure file
#     NOTE: No log functions are currently available --if sourcing this conf file fails, use generic, echoed logging
#####################################################################################################################################################################################################
CONFIG_FAIL_FILE_NAME="${FAIL_CONF_PREFIX}.${CONF_EXT}"
# echo "CONFIG_FAIL_FILE_NAME: ${CONFIG_FAIL_FILE_NAME}"
CONFIG_FAIL_FILE="${CONF_DIR}/${CONFIG_FAIL_FILE_NAME}"
# echo "CONFIG_FAIL_FILE: ${CONFIG_FAIL_FILE}"

[[ ! -f "${CONFIG_FAIL_FILE}" ]] && { echo "Error: Config Failure File: \"${CONFIG_FAIL_FILE}\" does not exist"; set -e && exit 1; }
# echo "Validated Config Failure File: ${CONFIG_FAIL_FILE}"
# echo "Sourcing Config Failure File: ${CONFIG_FAIL_FILE}"
source "${CONFIG_FAIL_FILE}"; SUCCESS="$?"
# echo "Completed sourcing config failure file: ${CONFIG_FAIL_FILE}"
[[ "${SUCCESS}" != "0" ]] && { echo "Error: Failed to source Config Failure file: \"${CONFIG_FAIL_FILE}\", (returned: ${SUCCESS})"; set -e && exit 1; }
# echo "Config Failure file sourced successfully"

#####################################################################################################################################################################################################
# Validate and source the function config file
#     NOTE: log_critical and its alias log_error, defined in config_fail.conf file, are the only log function available.
#####################################################################################################################################################################################################
# TODO: This needs to be a common function
INIT_FN_FILE_NAME="${CURRENT_NAME%.*}${FUNCTION_CONF_INFIX}.${CURRENT_NAME#*.}"
# echo "INIT_FN_FILE_NAME: ${INIT_FN_FILE_NAME}"
INIT_FN_FILE="${CONF_DIR}/${INIT_FN_FILE_NAME}"
# echo "INIT_FN_FILE: ${INIT_FN_FILE}"

[[ ! -f "${INIT_FN_FILE}" ]] && log_critical "Init Function File: \"${INIT_FN_FILE}\" does not exist"
# echo "Validated Init Function File: \"${INIT_FN_FILE}\""
# echo "Sourcing Init Function File: ${INIT_FN_FILE}"
source "${INIT_FN_FILE}"; SUCCESS="$?"
# echo "Completed sourcing Init Function file: ${INIT_FN_FILE}"
[[ "${SUCCESS}" != "0" ]] && log_critical "Failed to source Init Function file: \"${INIT_FN_FILE}\", (returned: ${SUCCESS})"
# echo "Init Function file sourced successfully"


#####################################################################################################################################################################################################
# Validate and source the logging config file
#     NOTE: All log functions are available if sourcing this conf file is successful.
#####################################################################################################################################################################################################
LOGGING_CONF_FILE_NAME="${LOGGING_CONF_PREFIX}.${CONF_EXT}"
# echo "LOGGING_CONF_FILE_NAME: ${LOGGING_CONF_FILE_NAME}"
LOGGING_CONF_FILE="${CONF_DIR}/${LOGGING_CONF_FILE_NAME}"
# echo "LOGGING_CONF_FILE: ${LOGGING_CONF_FILE}"

[[ ! -f "${LOGGING_CONF_FILE}" ]] && log_critical "Logging Config File: \"${LOGGING_CONF_FILE}\" does not exist"
# echo "Validated Logging Config File: \"${LOGGING_CONF_FILE}\""
# echo "Sourcing Logging Config File: ${LOGGING_CONF_FILE}"

source "${LOGGING_CONF_FILE}"; SUCCESS="$?"

# echo "Completed sourcing Logging config file"

log_error "sourced logging config file"
log_warning "sourced logging config file"
log_info "sourced logging config file"
log_debug "sourced logging config file"

# echo "Completed sourcing Logging config file: \"${LOGGING_CONF_FILE}\""
[[ "${SUCCESS}" != "0" ]] && log_critical "Failed to source Logging config file: \"${LOGGING_CONF_FILE}\", (returned: ${SUCCESS})"
# echo "Logging config file sourced successfully"
log_debug "Completed Successfully sourcing Logging config file: \"${LOGGING_CONF_FILE}\", (returned \"${SUCCESS}\")"


#####################################################################################################################################################################################################
# Validate and source the common config file
#####################################################################################################################################################################################################
COMMON_CONF_FILE_NAME="${COMMON_CONF_PREFIX}.${CONF_EXT}"
# echo "COMMON_CONF_FILE_NAME: ${COMMON_CONF_FILE_NAME}"
COMMON_CONF_FILE="${CONF_DIR}/${COMMON_CONF_FILE_NAME}"
# echo "COMMON_CONF_FILE: ${COMMON_CONF_FILE}"

[[ ! -f "${COMMON_CONF_FILE}" ]] && log_critical "Common Config File: \"${COMMON_CONF_FILE}\" does not exist"
# echo "Validated Common Config File: \"${COMMON_CONF_FILE}\""
# echo "Sourcing Common Config File: ${COMMON_CONF_FILE}"
source "${COMMON_CONF_FILE}"; SUCCESS="$?"
# echo "Completed sourcing Common config file: \"${COMMON_CONF_FILE}\""
[[ "${SUCCESS}" != "0" ]] && log_critical "Error: Failed to source Common config file: \"${COMMON_CONF_FILE}\", (returned: ${SUCCESS})"
log_debug "Completed Successfully sourcing Common config file: \"${COMMON_CONF_FILE}\", (returned \"${SUCCESS}\")"
# echo "Common config file sourced successfully"


#####################################################################################################################################################################################################
# Parse and Validate the Parent Path Param
#####################################################################################################################################################################################################
# echo "Rel path version of PARENT_PATH_PARAM: \"${PARENT_PATH_PARAM}\""
PARENT_PATH_PARAM="$(realpath "${PARENT_PATH_PARAM}")"
# echo "Abs path version of PARENT_PATH_PARAM: \"${PARENT_PATH_PARAM}\""
[[ ("${PARENT_PATH_PARAM}" == "") || ( ! -f "${PARENT_PATH_PARAM}" ) ]] && log_critical "Parent Path Param: ${PARENT_PATH_PARAM} is not a valid file. Unable to Continue."
log_debug "Received Valid Parent Path Param: ${PARENT_PATH_PARAM}"
# echo "Parent Path Param validated successfully"


#####################################################################################################################################################################################################
# Retrieve and Validate parent script info and constants
#####################################################################################################################################################################################################
PARENT_PID="${PPID}"
# echo "PARENT_PID: ${PARENT_PID}"
PARENT_CMD="$( tr -d '\0' < /proc/${PARENT_PID}/cmdline )"
# echo "PARENT_CMD: ${PARENT_CMD}"
PARENT_CALL="$(ps -o args= ${PARENT_PID})"
# echo "PARENT_CALL: ${PARENT_CALL}"
PARENT_PARAM="${PARENT_PATH_PARAM}"
# echo "PARENT_PARAM: ${PARENT_PARAM}"

log_debug "Parent Param: ${PARENT_PARAM}"
# echo "Parent Param validated successfully"

# Validate potential parent script path candidates
# echo "Validate potential parent script path candidates"
validate_parent_path "${PARENT_CMD}" "${PARENT_CALL}" "${PARENT_PARAM}"
log_debug "Parent Script Path: \"${PARENT_SCRIPT_PATH}\""
# echo "Parent Script Path validated successfully"


#####################################################################################################################################################################################################
# Build Parent Script Config File Path
#####################################################################################################################################################################################################
PARENT_CONF="${PARENT_SCRIPT_PATH%.*}.${CONF_EXT}"
log_debug "Parent Script Config File: \"${PARENT_CONF}\""
PARENT_CONF_FILENAME="$(basename "${PARENT_CONF}")"
log_debug "Parent Script Config File Name: \"${PARENT_CONF_FILENAME}\""
PARENT_DIR="$(dirname "${PARENT_CONF}")"
log_debug "Parent Script Config File Dir: \"${PARENT_DIR}\""
PARENT_ROOT_DIR="$(dirname "${PARENT_DIR}")"
log_debug "Parent Script Config File Root Dir: \"${PARENT_ROOT_DIR}\""
PARENT_CONF_DIR="${PARENT_ROOT_DIR}/${CONF_EXT}"
log_debug "Parent Script Config Dir: \"${PARENT_CONF_DIR}\""


#####################################################################################################################################################################################################
# Get project directory constants
#####################################################################################################################################################################################################
DEV_DIR="${HOME_DIR}/${DEV_DIR_NAME}"
log_debug "Dev Dir: \"${DEV_DIR}\""
PROJ_ROOT_DIR="${DEV_DIR}/${PROJ_LANG_DIR_NAME}"
log_debug "Project Root Dir: \"${PROJ_ROOT_DIR}\""
PROJ_DIR="${PROJ_ROOT_DIR}/${SUB_PROJ_NAME}/${APP_NAME}"
log_debug "Project Dir: \"${PROJ_DIR}\""
PROJ_CONF_DIR="${PROJ_DIR}/${CONF_EXT}"
log_debug "Project Config Dir: \"${PROJ_CONF_DIR}\""


#####################################################################################################################################################################################################
# Validate config directory and Primary Config File for calling script
#####################################################################################################################################################################################################
# echo "Validating conf dir for Calling Script primary config file: \"${PARENT_CONF_DIR}\""
# echo "Validating dir for calling script primary config file against project conf dir: \"${PROJ_CONF_DIR}\""
validate_conf_dir "${PARENT_CONF_DIR}" "${PROJ_CONF_DIR}"
# echo "Completed validating conf dir for Calling Script primary config file: \"${PARENT_CONF_DIR}\""

log_info "Successfully Validated conf dir for Calling Script primary config file: \"${PARENT_CONF_DIR}\""
CONF_FILE="${PARENT_CONF_DIR}/${PARENT_CONF_FILENAME}"
log_debug "Calling Script Primary Conf File: \"${CONF_FILE}\""

# Validate the Parent Script's primary config file
# [[ "$(validate_conf_file "${CONF_FILE}")" != "0" ]] && { log_error "Error: Failed to validate Primary config file: \"${CONF_FILE}\""; set -e && exit 1; }
# echo "Validating the Parent Script's primary config file: \"${CONF_FILE}\""
validate_conf_file "${CONF_FILE}"; SUCCESS="$?"
# echo "Completed validating the Parent Script's primary config file: \"${CONF_FILE}\""

# echo "Check status of validate_conf_file"
[[ "${SUCCESS}" != "${TRUE}" ]] && log_critical "Error: Failed to validate Primary config file: \"${CONF_FILE}\""
# echo "Completed validating the Parent Script's primary config file: ${CONF_FILE}"

log_info "Successfully Validated the Parent Script's primary config file: ${CONF_FILE}"
export CONF_FILE


#####################################################################################################################################################################################################
# Source the Calling Script's Primary config file and check result
#####################################################################################################################################################################################################
log_debug "Sourcing Calling Script's Primary config file: \"${CONF_FILE}\""
# echo "Sourcing Calling Script's Primary config file: \"${CONF_FILE}\""
source "${CONF_FILE}"; SUCCESS="$?"
# echo "Completed sourcing Calling Script's Primary config file: \"${CONF_FILE}\""

# echo "Check status of sourcing Calling Script's Primary config file"
[[ "${SUCCESS}" != "${TRUE}" ]] && { log_critical "Error: Failed to source Primary config file: \"${CONF_FILE}\""; set -e && exit 1; }
# echo "Completed validating the sourcing of the Calling Script's Primary config file: \"${CONF_FILE}\""

log_info "Completed sourcing Primary config file. Returned \"${SUCCESS}\""

return "${TRUE}"
