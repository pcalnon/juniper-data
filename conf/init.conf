#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Prototype:     Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
# File Name:     init.conf
# Author:        Paul Calnon
# Version:       0.1.4 (0.7.3)
#
# Date:          2025-11-10
# Last Modified: 2025-12-17
#
# License:       MIT License
# Copyright:     Copyright (c) 2024-2025 Paul Calnon
#
# Description:
#    This Script serves as the initialization config file for the Juniper Project's juniper_canopy prototype
#    Warning:  This Script / Config file is sourced by the try.bash script
#
#####################################################################################################################################################################################################
# Notes:
#     Warning:  This Config file is sourced by the all Juniper Canopy util scripts including the try.bash and get_code_stats.bash scripts
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define Top Level Constants for Script
#####################################################################################################################################################################################################
export TRUE="0"
export FALSE="1"

# export DEBUG="${FALSE}"
export DEBUG="${TRUE}"


#####################################################################################################################################################################################################
# Define Constants for Common and Logging config files
#####################################################################################################################################################################################################
BASH_EXT="bash"
CONF_EXT="conf"
UTIL_DIR_NAME="util"

COMMON_CONF_PREFIX="common"
LOGGING_CONF_PREFIX="logging"

PARENT_INFO_COUNT=4


#####################################################################################################################################################################################################
# Parse and Validate the Parent Path Param
#####################################################################################################################################################################################################
[[ "${1}" != "" ]] && PARENT_PATH_PARAM="${1}" || PARENT_PATH_PARAM=""
# log_debug "Parent Path Param: ${PARENT_PATH_PARAM}"
[[ ("${PARENT_PATH_PARAM}" != "") && ( ! -f "${PARENT_PATH_PARAM}" ) ]] && { log_warning "Parent Path Param: ${PARENT_PATH_PARAM} is not a valid file"; PARENT_PATH_PARAM=""; }


#####################################################################################################################################################################################################
# Build Config File dir
#####################################################################################################################################################################################################
CURRENT_PATH="$(realpath "${BASH_SOURCE[0]}")"
# echo "Script Path: ${CURRENT_PATH}"
# SCRIPT_NAME="$(basename "${CURRENT_PATH}")"
# echo "Script Name: ${SCRIPT_NAME}"
CURRENT_DIR="$(dirname "${CURRENT_PATH}")"
# echo "Script Dir: ${CURRENT_DIR}"
PROJ_ROOT_DIR="$(dirname "${CURRENT_DIR}")"
# echo "Project Root Dir: ${PROJ_ROOT_DIR}"
# SCRIPT_NAME_ROOT="${SCRIPT_NAME%.*}"
# echo "Script Name Root: ${SCRIPT_NAME_ROOT}"
CONF_DIR="${PROJ_ROOT_DIR}/${CONF_EXT}"
# echo "Config Dir: ${CONF_DIR}"


#####################################################################################################################################################################################################
# Build Logging and Common Config File Names and paths
#####################################################################################################################################################################################################
export LOGGING_CONF_FILE_NAME="${LOGGING_CONF_PREFIX}.${CONF_EXT}"
# echo "Logging conf file name: ${LOGGING_CONF_FILE_NAME}"
export LOGGING_CONF_FILE="${CONF_DIR}/${LOGGING_CONF_FILE_NAME}"
# echo "LOGGING_CONF_FILE: ${LOGGING_CONF_FILE}"
export COMMON_CONF_FILE_NAME="${COMMON_CONF_PREFIX}.${CONF_EXT}"
# echo "Common conf file name: ${COMMON_CONF_FILE_NAME}"
export COMMON_CONF_FILE="${CONF_DIR}/${COMMON_CONF_FILE_NAME}"
# echo "COMMON_CONF_FILE: ${COMMON_CONF_FILE}"


#####################################################################################################################################################################################################
# Validate and source the logging config file
#####################################################################################################################################################################################################
[[ ! -f "${LOGGING_CONF_FILE}" ]] && { echo "Error: Logging Config File: \"${LOGGING_CONF_FILE}\" does not exist"; exit 1; }
source "${LOGGING_CONF_FILE}"; SUCCESS="$?"
[[ "${SUCCESS}" != "0" ]] && { echo "Error: Failed to source Logging config file: \"${LOGGING_CONF_FILE}\", (returned: ${SUCCESS})"; exit 1; }
log_debug "Completed Successfully sourcing Logging config file: \"${LOGGING_CONF_FILE}\", (returned \"${SUCCESS}\")"

# Source the logging config file
# echo "Logging Conf File: \"${LOGGING_CONF_FILE}\""
# echo "source \"${LOGGING_CONF_FILE}\""
# source "${LOGGING_CONF_FILE}"; SUCCESS="$?"
# [[ "${SUCCESS}" != "0" ]] && { echo "Error: Failed to source Logging config file: \"${LOGGING_CONF_FILE}\", (returned: ${SUCCESS})"; exit 1; }
# log_debug "Completed Successfully sourcing Logging config file: \"${LOGGING_CONF_FILE}\", (returned \"${SUCCESS}\")"
# PARENT_CONF_DIR="${PARENT_ROOT_DIR}/${CONF_EXT}"
# echo "Parent Conf Dir: ${PARENT_CONF_DIR}"
# PARENT_CONF_FILE="${PARENT_CONF_DIR}/${PARENT_CONF_FILENAME}"
# echo "Parent Conf File: ${PARENT_CONF_FILE}"

#####################################################################################################################################################################################################
# Validate and source the common config file
#####################################################################################################################################################################################################
[[ ! -f "${COMMON_CONF_FILE}" ]] && { echo "Error: Common Config File: \"${COMMON_CONF_FILE}\" does not exist"; exit 1; }
source "${COMMON_CONF_FILE}"; SUCCESS="$?"
[[ "${SUCCESS}" != "0" ]] && { echo "Error: Failed to source Common config file: \"${COMMON_CONF_FILE}\", (returned: ${SUCCESS})"; exit 1; }
log_debug "Completed Successfully sourcing Common config file: \"${COMMON_CONF_FILE}\", (returned \"${SUCCESS}\")"


#####################################################################################################################################################################################################
# Define function to validate parent script info
#####################################################################################################################################################################################################
function validate_parent_script() {
    [[ "$1" != "" ]] && PARENT_SCRIPT="$1" || { PARENT_SCRIPT=""; return 1; }
    [[ "$2" != "" ]] && INVALID_VALUE="$2" || INVALID_VALUE="${BASH_EXT}"
    log_debug "Validating Parent Script Call Info: ${PARENT_SCRIPT}"

    PARENT_SCRIPT="${PARENT_SCRIPT#*${INVALID_VALUE}}"
    log_debug "Removed shell reference from Parent Script: \"${PARENT_SCRIPT}\""

    [[ "${PARENT_SCRIPT}" != "" ]] && PARENT_SCRIPT="$(realpath "${PARENT_SCRIPT}")" || { log_warning "Parent Script Call Info is empty: \"${PARENT_SCRIPT}\""; return 1; }
    log_debug "Found Parent Script Absolute PaTH: \"${PARENT_SCRIPT}\""

    [[ ( "${PARENT_SCRIPT}" == "" ) || ( -f "${PARENT_SCRIPT}" ) ]] && { log_warning "Invalid Parent Script Call Info: \"${PARENT_SCRIPT}\" does not exist"; return 1; }
    log_debug "Validated Parent Script File at Path: \"${PARENT_SCRIPT}\""
    return 0
}

function validate_parent_path() {
    log_debug "Validating Parent Path Candidates"

    # Create an array for easier validation
    local declare -a PARENT_SCRIPT_ARRAY = ${@}
    # for PARAM in ${@}; do
    #     PARENT_SCRIPT_ARRAY+=("${PARAM}")
    # done
    (( ${#PARENT_SCRIPT_ARRAY[@]} < PARENT_INFO_COUNT )) && log_warning "Received fewer than expected parent script info candidates to validate: ${#PARENT_SCRIPT_ARRAY[@]} (expected ${PARENT_INFO_COUNT})"

    export PARENT_SCRIPT_PATH=""
    for CHECK in "${PARENT_SCRIPT_ARRAY[@]}"; do
        log_debug "Current Parent Script Candidate Check: \"${CHECK}\""
        if [[ "$(validate_parent_script "${CHECK}" "${BASH_EXT}")" == "${TRUE}" ]]; then
            export PARENT_SCRIPT_PATH="${CHECK}"
            break
        fi
    done
    [[ "${PARENT_SCRIPT_PATH}" == "" ]] && { log_error "Error: Unable to determine Parent Script Path: \"${PARENT_SCRIPT_PATH}\""; set -e; exit 1; }
    log_debug "Successfully Validated the Parent Script Path: \"${PARENT_SCRIPT_PATH}\""
}

function validate_conf_dir() {
    log_debug "Validating Config Dir using Parent and Project Config Dir Candidates"
    local CONF_DIR_1="$1"
    local CONF_DIR_2="$2"

    if [[ ( ( "${CONF_DIR_1}" == "" ) || ( ! -d "${CONF_DIR_1}" ) ) && ( ( "${CONF_DIR_2}" == "" ) || ( ! -d "${CONF_DIR_2}" ) ) ]]; then
        log_error "Error: Both Conf Dir candidates: \"${CONF_DIR_1}\" and \"${CONF_DIR_2}\" are empty or invalid directories"
        set -e && exit 1
    elif [[ ( "${CONF_DIR_1}" == "" ) || ( ! -d "${CONF_DIR_1}" ) ]]; then
        export CONF_DIR="${CONF_DIR_2}"
        log_debug "Conf Dir candidate: \"${CONF_DIR_1}\", is empty or invalid, using alternate Conf Dir candidate: \"${CONF_DIR_2}\""
    else
        export CONF_DIR="${CONF_DIR_1}"
        log_debug "Parent Conf Dir: \"${CONF_DIR_1}\" is valid, using Parent Conf Dir"
    fi
    return 0
}

function validate_conf_file() {
    local CONF_FILE="$1"
    log_debug "Validating Config File: \"${CONF_FILE}\""
    [[ ( "${CONF_FILE}" == "" ) || ( ! -f "${CONF_FILE}" ) ]] && { log_error "Error: Config File: \"${CONF_FILE}\" is empty or does not exist"; set -e && exit 1; }
    log_debug "Successfully Validated Calling Script Primary Config File: \"${CONF_FILE}\""
    return 0
}


# #####################################################################################################################################################################################################
# # Current Config file info
# #####################################################################################################################################################################################################
# SCRIPT_PATH="$(realpath "${BASH_SOURCE[0]}")"
# echo "Script Path: ${SCRIPT_PATH}"
# SCRIPT_NAME="$(basename "${SCRIPT_PATH}")"
# echo "Script Name: ${SCRIPT_NAME}"
# SCRIPT_DIR="$(dirname "${SCRIPT_PATH}")"
# echo "Script Dir: ${SCRIPT_DIR}"
# PROJ_ROOT_DIR="$(dirname "${SCRIPT_DIR}")"
# echo "Project Root Dir: ${PROJ_ROOT_DIR}"
# SCRIPT_NAME_ROOT="${SCRIPT_NAME%.*}"
# echo "Script Name Root: ${SCRIPT_NAME_ROOT}"
# CONF_DIR="${PROJ_ROOT_DIR}/${CONF_EXT}"
# echo "Config Dir: ${CONF_DIR}"


#####################################################################################################################################################################################################
# Retrieve and Validate parent script info and constants
#####################################################################################################################################################################################################
PARENT_PID="${PPID}"
log_debug "Parent Pid: \"${PARENT_PID}\""
PARENT_READ="$(IFS== read -d '' _ PARENT_CMD < /proc/${PARENT_PID}/cmdline)"
log_debug "Parent Raw Call: From read: \"${PARENT_READ}\""
PARENT_CMD="$( tr -d '\0' < /proc/${PARENT_PID}/cmdline )"
log_debug "Parent Raw Call: From cmd: \"${PARENT_CMD}\""
PARENT_CALL="$(ps -o args= ${PARENT_PID})"
log_debug "Parent Raw Call: From ps: \"${PARENT_CALL}\""
PARENT_PARAM="${PARENT_PATH_PARAM}"
log_debug "Parent Param: \"${PARENT_PARAM}\""

# Validate potential parent script path candidates
validate_parent_path "${PARENT_READ}" "${PARENT_CMD}" "${PARENT_CALL}" "${PARENT_PARAM}"
log_debug "Parent Script Path Validated: ${PARENT_SCRIPT_PATH}"


#####################################################################################################################################################################################################
# Build Parent Script Config File Path
#####################################################################################################################################################################################################
export PARENT_CONF="${PARENT_SCRIPT_PATH%.*}.${CONF_EXT}"
log_debug "Parent Config: ${PARENT_CONF}"
export PARENT_CONF_FILENAME="$(basename "${PARENT_CONF}")"
log_debug "Parent Config Filename: ${PARENT_CONF_FILENAME}"
export PARENT_DIR="$(dirname "${PARENT_CONF}")"
log_debug "Parent Dir: ${PARENT_DIR}"
export PARENT_ROOT_DIR="$(dirname "${PARENT_DIR}")"
log_debug "Parent Root Dir: ${PARENT_ROOT_DIR}"
export PARENT_CONF_DIR="${PARENT_ROOT_DIR}/${CONF_EXT}"
log_debug "Parent Conf Dir: ${PARENT_CONF_DIR}"
# export PARENT_CONF_FILE="${PARENT_CONF_DIR}/${PARENT_CONF_FILENAME}"
# log_debug "Parent Conf File: ${PARENT_CONF_FILE}"


#####################################################################################################################################################################################################
# Get project directory constants
#####################################################################################################################################################################################################
export HOME_DIR="${HOME}"
log_debug "Home Dir: ${HOME_DIR}"
export PROJ_NAME="Juniper"
log_debug "Project Name: ${PROJ_NAME}"
export SUB_PROJ_NAME="JuniperCanopy"
log_debug "Sub Project Name: ${SUB_PROJ_NAME}"
export APP_NAME="juniper_canopy"
log_debug "App Name: ${APP_NAME}"
export PROJ_LANG_DIR_NAME="python"
log_debug "Project Lang Dir Name: ${PROJ_LANG_DIR_NAME}"
export DEV_DIR_NAME="Development"
log_debug "Dev Dir Name: ${DEV_DIR_NAME}"
export DEV_DIR="${HOME_DIR}/${DEV_DIR_NAME}"
log_debug "Dev Dir: ${DEV_DIR}"
export PROJ_ROOT_DIR="${DEV_DIR}/${PROJ_LANG_DIR_NAME}"
log_debug "Project Root Dir: ${PROJ_ROOT_DIR}"
export PROJ_DIR="${PROJ_ROOT_DIR}/${SUB_PROJ_NAME}/${APP_NAME}"
log_debug "Project Dir: ${PROJ_DIR}"
# export PROJ_UTIL_DIR="${PROJ_DIR}/${UTIL_DIR_NAME}"
# log_debug "Project Util Dir: ${PROJ_UTIL_DIR}"
export PROJ_CONF_DIR="${PROJ_DIR}/${CONF_EXT}"
log_debug "Project Conf Dir: ${PROJ_CONF_DIR}"
# export PROJ_CONF_FILE="${PROJ_CONF_DIR}/${CONF_FILE_NAME}"
# log_debug "Project Conf File: ${PROJ_CONF_FILE}"


#####################################################################################################################################################################################################
# Validate config directory and Primary Config File for calling script
#####################################################################################################################################################################################################
validate_conf_dir "${PARENT_CONF_DIR}" "${PROJ_CONF_DIR}"
log_info "Successfully Validated conf dir for Calling Script primary config file: \"${CONF_DIR}\""

CONF_FILE="${CONF_DIR}/${PARENT_CONF_FILENAME}"
log_debug "Calling Script Primary Conf File: \"${CONF_FILE}\""

# Validate the Parent Script's primary config file
[[ "$(validate_conf_file "${CONF_FILE}")" != "0" ]] && { log_error "Error: Failed to validate Primary config file: \"${CONF_FILE}\""; set -e && exit 1; }
log_info "Successfully Validated the Parent Script's primary config file: ${CONF_FILE}"
export ${CONF_FILE}


#####################################################################################################################################################################################################
# Source the config files
#####################################################################################################################################################################################################
# # Source the logging config file
# echo "Logging Conf File: \"${LOGGING_CONF_FILE}\""
# echo "source \"${LOGGING_CONF_FILE}\""
# source "${LOGGING_CONF_FILE}"; SUCCESS="$?"
# log_debug "Completed sourcing Logging config file. Returned \"${SUCCESS}\""

# # Source the common config file
# echo "Common Conf File: \"${COMMON_CONF_FILE}\""
# echo "source \"${COMMON_CONF_FILE}\""
# source "${COMMON_CONF_FILE}"; SUCCESS="$?"
# log_debug "Completed sourcing Common config file. Returned \"${SUCCESS}\""

# # Source the primary config file for the parent script
# echo "Conf file: \"${CONF_FILE}\""
# echo "source \"${CONF_FILE}\""

source "${CONF_FILE}"; SUCCESS="$?"

# Validate the sourcing of the primary config file
if [[ "${SUCCESS}" != "0" ]]; then
    log_error "Error: Failed to source Primary config file: \"${CONF_FILE}\""
    set -e && exit 1
fi
log_info "Completed sourcing Primary config file. Returned \"${SUCCESS}\""
return 0
