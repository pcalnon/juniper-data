#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperData
# Application:   juniper_data
# Purpose:       Cascade Correlation Neural Network
#
# Author:        Paul Calnon
# Version:       0.1.4 (0.7.3)
# File Name:     init.conf
# File Path:     <Project>/<Sub-Project>/<Application>/conf/
#
# Date Created:  2025-11-10
# Last Modified: 2026-01-19
#
# License:       MIT License
# Copyright:     Copyright (c) 2024,2025,2026 Paul Calnon
#
# Description:
#    This Script serves as the initialization config file for the Juniper Project's Cascade Correlation Neural Network prototype
#    Warning:  This Script / Config file is sourced by the try.bash script
#
#####################################################################################################################################################################################################
# Notes:
#     Warning:  This Config file is sourced by the all Juniper Data util scripts including the try.bash and get_code_stats.bash scripts
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define Top Level Constants for Script
#####################################################################################################################################################################################################
# echo "init.conf: Define Top Level Constants for Script"
export TRUE="0"
export FALSE="1"

export DEBUG_FLAG="${FALSE}"
# export DEBUG_FLAG="${TRUE}"
[[ "${DEBUG}" == "" ]] && export DEBUG="${DEBUG_FLAG}"


#####################################################################################################################################################################################################
# Define Bash Source indices for calling script info
#####################################################################################################################################################################################################
export SCRIPT_NAME_ID="1"
export LINE_NO_ID="0"
export FUNC_NAME_ID="1"


#####################################################################################################################################################################################################
# Get Project Constants
#####################################################################################################################################################################################################
export CONF_EXT="conf"
export LOGS_EXT="log"
export COMMON_FILE_ROOT="common"
export FUNCTION_CONF_INFIX="_function"


#####################################################################################################################################################################################################
# Define Project Environment Constants
#####################################################################################################################################################################################################
export CURRENT_PATH="$(realpath "${BASH_SOURCE[0]}")"
export INIT_CONF_DIR="$(dirname "${CURRENT_PATH}")"
export PROJ_DIR="$(dirname "${INIT_CONF_DIR}")"
export APP_NAME="$(basename "${PROJ_DIR}")"


#####################################################################################################################################################################################################
# Define Minimal Logging env Constants needed to configure log_fatal function.
#####################################################################################################################################################################################################
export LOGS_DIR_NAME="${LOGS_EXT}s"
export LOGS_DIR="${PROJ_DIR}/${LOGS_DIR_NAME}"
export LOG_FILE_NAME="${APP_NAME}.${LOGS_EXT}"
export LOG_FILE="${LOGS_DIR}/${LOG_FILE_NAME}"


#####################################################################################################################################################################################################
# Compatible names for logging_functions helpers
#####################################################################################################################################################################################################
export LOG_EXT="${LOGS_EXT}"
export LOG_DIR_NAME="${LOGS_DIR_NAME}"
export LOG_DIR="${LOGS_DIR}"


#####################################################################################################################################################################################################
# Define Calling Script Logging Info
#####################################################################################################################################################################################################
[[ "${BASH_SOURCE["${SCRIPT_NAME_ID}"]}" != "" ]] && CALLING_SCRIPT="${BASH_SOURCE[${SCRIPT_NAME_ID}]}" || CALLING_SCRIPT="${PARENT_PATH_PARAM}"    # \"  WTAF.  Grr
export CALLING_SCRIPT_PATH="$(realpath "${CALLING_SCRIPT}")"
export CALLING_SCRIPT="$(basename "${CALLING_SCRIPT_PATH}")"
export CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
export CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"


#####################################################################################################################################################################################################
# Define Fatal Error logging
#####################################################################################################################################################################################################
function log_fatal() {
    MESSAGE="$1"
    RESET="\033[0m" && COLOR_FATAL="\033[1;97;41m"
    printf "%b%-21s %-28s %-21s %-11s %s%b\n" "${COLOR_FATAL}" "($(date +%F_%T))" "${CALLING_SCRIPT}:${CALLING_LINE})" "${CALLING_FUNC}:" "[FATAL]" "${MESSAGE}" "${RESET}" | tee -a "${LOG_FILE}" >&2
    set -e; exit $(( FALSE ))
}
export -f log_fatal  # Critical Error Logging is defined from this point


#####################################################################################################################################################################################################
# Define Project Environment, Common Config file, Relative Path Constants
#####################################################################################################################################################################################################
export CONF_DIR_NAME="${CONF_EXT}"
export CONF_DIR="${PROJ_DIR}/${CONF_DIR_NAME}"
export COMMON_FILE_NAME="${COMMON_FILE_ROOT}.${CONF_EXT}"
export COMMON_FILE="${CONF_DIR}/${COMMON_FILE_NAME}"

# CALLING_PID: PID of the script that sourced init.conf (e.g., get_code_stats.bash, __git_log_weeks.bash).  This uses $$ (current shell PID) not $PPID (OS parent), so it correctly identifies the calling script
: "${CALLING_PID:=$$}"
export CALLING_PID
# PARENT_PID: True OS parent PID (preserved for backwards compatibility)
: "${PARENT_PID:=${PPID}}"
export PARENT_PID


#####################################################################################################################################################################################################
# Source and Validate the Common Config File
#####################################################################################################################################################################################################
[[ ! -f "${COMMON_FILE}" ]] && log_fatal "Common config file not found: ${COMMON_FILE}"
source "${COMMON_FILE}"; SUCCESS="$?"
[[ "${SUCCESS}" != "${TRUE}" ]] && log_fatal "Failed to source common config file: \"${COMMON_FILE}\", (Returned: \"${SUCCESS}\")"
return $(( TRUE ))
